# flutter_miniaudio (ä¸­æ–‡æ–‡æ¡£)

åŸºäº [miniaudio](https://miniaudi.io/) æ„å»ºçš„é«˜æ€§èƒ½ã€è·¨å¹³å° Flutter ä½å»¶è¿ŸéŸ³é¢‘æ’ä»¶ã€‚

**ä¸“ä¸ºå®æ—¶åº”ç”¨è®¾è®¡**ï¼šæ¨¡æ‹Ÿå™¨ã€æ¸¸æˆã€VoIP å’Œåˆæˆå™¨ã€‚

---

## ğŸ“– æ ¸å¿ƒåŸç†ï¼šè§£å†³â€œéŸ³é¢‘åŒæ­¥â€é—®é¢˜

### æŒ‘æˆ˜ï¼šâ€œæ¨æ¨¡å¼ (Push)â€ vs â€œæ‹‰æ¨¡å¼ (Pull)â€
æ ‡å‡†çš„ Flutter éŸ³é¢‘æ’ä»¶ï¼ˆå¦‚ `audioplayers` æˆ– `flutter_soloud`ï¼‰é€šå¸¸ä½¿ç”¨ **æ¨æ¨¡å¼ (Push-Mode)**ï¼š
1. Dart ä»£ç ç”Ÿæˆæˆ–è§£ç éŸ³é¢‘æ•°æ®ã€‚
2. å°†æ•°æ®â€œæ¨â€é€åˆ°åŸç”Ÿå±‚ã€‚
3. åŸç”Ÿå±‚è¿›è¡Œç¼“å†²å¹¶åœ¨å‡†å¤‡å¥½æ—¶æ’­æ”¾ã€‚

**æ¨æ¨¡å¼åœ¨å®æ—¶åº”ç”¨ä¸­çš„é—®é¢˜ï¼š**
*   **æ—¶é’Ÿæ¼‚ç§» (Clock Drift)ï¼š** ä½ çš„æ¸¸æˆå¾ªç¯è¿è¡Œåœ¨ç³»ç»Ÿæ—¶é’Ÿï¼ˆTimeï¼‰ä¸Šï¼Œè€ŒéŸ³é¢‘ç¡¬ä»¶è¿è¡Œåœ¨è‡ªå·±çš„æ™¶æŒ¯æ—¶é’Ÿï¼ˆSample Rateï¼‰ä¸Šã€‚è¿™ä¸¤ä¸ªæ—¶é’Ÿæ°¸è¿œæ— æ³•å®Œç¾åŒæ­¥ã€‚
*   **åæœï¼š** 
    *   å¦‚æœ Dart è·‘å¾—å¤ªå¿« -> ç¼“å†²åŒºå †ç§¯ -> **é«˜å»¶è¿Ÿ** (å£°éŸ³æ»å)ã€‚
    *   å¦‚æœ Dart è·‘å¾—å¤ªæ…¢ -> ç¼“å†²åŒºè€—å°½ -> **çˆ†éŸ³/å¡é¡¿** (Underrun)ã€‚
*   **å¤æ‚çš„ä¿®å¤ï¼š** å¼€å‘è€…é€šå¸¸å°è¯•åœ¨ Dart ä¸­ä½¿ç”¨ `sleep()` æ¥é˜»å¡çº¿ç¨‹ä»¥ç­‰å¾…ç¼“å†²åŒºæ¶ˆè€—ï¼Œä½† Dart æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼ˆisolateï¼‰ï¼Œç²¾ç¡®é˜»å¡éå¸¸å›°éš¾ï¼Œä¼šå¯¼è‡´å¸§ç‡ä¸ç¨³å®šã€‚

### è§£å†³æ–¹æ¡ˆï¼šâ€œæ‹‰æ¨¡å¼ (Pull-Mode)â€ (éŸ³é¢‘ä½œä¸ºä¸»æ—¶é’Ÿ)
`miniaudio_ffi` é‡‡ç”¨äº† **æ‹‰æ¨¡å¼** æ¶æ„ï¼Œè¿™æ˜¯æ¨¡æ‹Ÿå™¨ï¼ˆå¦‚ RetroArchï¼‰å’Œä¸“ä¸šéŸ³é¢‘å·¥å…·çš„è¡Œä¸šæ ‡å‡†ï¼š

1.  **åŸç”Ÿå›è°ƒ (Native Callback)ï¼š** æ“ä½œç³»ç»ŸéŸ³é¢‘é©±åŠ¨ (AAudio, CoreAudio, WASAPI) ä¼šåœ¨éœ€è¦æ•°æ®æ—¶è§¦å‘é«˜ä¼˜å…ˆçº§å›è°ƒã€‚â€œæˆ‘ç°åœ¨éœ€è¦ 512 ä¸ªé‡‡æ ·ã€‚â€
2.  **å…±äº«å†…å­˜ç¯å½¢ç¼“å†²åŒº (Ring Buffer)ï¼š** æˆ‘ä»¬åœ¨ Dart å’Œ C ä¹‹é—´ä½¿ç”¨ä¸€ä¸ªæ— é”ç¯å½¢ç¼“å†²åŒº (FIFO)ã€‚
3.  **æµç¨‹ï¼š**
    *   **åŸç”Ÿç«¯ (æ¶ˆè´¹è€…)ï¼š** å”¤é†’ï¼Œä»ç¯å½¢ç¼“å†²åŒºè¯»å–æ•°æ®ï¼Œç„¶åä¼‘çœ ã€‚è¿™ä¸¥æ ¼æŒ‰ç…§ç¡¬ä»¶é‡‡æ ·ç‡å‘ç”Ÿã€‚
    *   **Dart ç«¯ (ç”Ÿäº§è€…)ï¼š** ä½ åªéœ€è¦å¾€ç¯å½¢ç¼“å†²åŒºå†™å…¥æ•°æ®ã€‚

**ä¸ºä»€ä¹ˆè¿™èƒ½è§£å†³åŒæ­¥é—®é¢˜ï¼š**
ä½ ä¸éœ€è¦çŒœæµ‹æ—¶é—´ï¼Œåªéœ€è¦æ£€æŸ¥ **â€œç¯å½¢ç¼“å†²åŒºæœ‰å¤šæ»¡ï¼Ÿâ€**ã€‚
*   å¦‚æœç¼“å†²åŒºå¤ªæ»¡ï¼š**ç­‰å¾… (Wait)**ã€‚ï¼ˆè®©æ¸¸æˆå¾ªç¯æ…¢ä¸‹æ¥ï¼‰
*   å¦‚æœç¼“å†²åŒºç©ºäº†ï¼š**åŠ é€Ÿ (Speed up)**ã€‚ï¼ˆè®©æ¨¡æ‹Ÿå™¨è·‘å¿«ç‚¹ï¼‰

è¿™ä½¿å¾— **éŸ³é¢‘ç¡¬ä»¶** æˆä¸ºä½ æ•´ä¸ªåº”ç”¨çš„ **ä¸»æ—¶é’Ÿ (Master Clock)**ï¼Œä»è€Œç¡®ä¿å®Œç¾çš„éŸ³ç”»åŒæ­¥å’Œé›¶å»¶è¿Ÿã€‚

---

## ğŸ— æ¶æ„å›¾

```mermaid
graph TD
    subgraph Dart Layer ["Dart å±‚"]
    GL[æ¸¸æˆå¾ªç¯ / æ¨¡æ‹Ÿå™¨] -->|ç”Ÿæˆ Int16 é‡‡æ ·| W[write()]
    W -->|å†…å­˜æ‹·è´| RB_Dart[(å…±äº«ç¯å½¢ç¼“å†²åŒº)]
    end

    subgraph Native Layer ["åŸç”Ÿå±‚ (C)"]
    RB_Native[(å…±äº«ç¯å½¢ç¼“å†²åŒº)] --- RB_Dart
    Driver[éŸ³é¢‘é©±åŠ¨\n(AAudio/CoreAudio/etc)] -->|å›è°ƒè¯·æ±‚æ•°æ®| CB[æ•°æ®å›è°ƒ]
    CB -->|ä» FIFO è¯»å–| RB_Native
    CB -->|PCM æ•°æ®| Speaker
    end
```

*   **é›¶æ‹·è´ (æ¥è¿‘)ï¼š** æ•°æ®åªä» Dart æ‹·è´ä¸€æ¬¡åˆ°å…±äº«ç¯å½¢ç¼“å†²åŒºã€‚åŸç”Ÿç«¯ç›´æ¥è¯»å–æ­¤ç¼“å†²åŒºã€‚
*   **æ—  JNI/MethodChannel å¼€é”€ï¼š** ä½¿ç”¨çº¯ `dart:ffi` è°ƒç”¨ï¼Œæ€§èƒ½æœ€å¤§åŒ–ã€‚

---

## ğŸš€ ç‰¹æ€§

- **æä½å»¶è¿Ÿ**ï¼šå¯é…ç½®ç¼“å†²åŒºå¤§å°ï¼ˆä½è‡³ ~10msï¼‰ã€‚
- **è·¨å¹³å°æ”¯æŒ**ï¼š
  - ğŸ¤– **Android**: AAudio (é«˜æ€§èƒ½) / OpenSL ES (å…¼å®¹)ã€‚
  - ğŸ **iOS/macOS**: CoreAudio / AudioUnitã€‚
  - ğŸªŸ **Windows**: WASAPIã€‚
  - ğŸ§ **Linux**: ALSA / PulseAudioã€‚
- **è½»é‡çº§**ï¼šæ— å¤–éƒ¨ä¾èµ–ã€‚ä»…ç¼–è¯‘ä¸€ä¸ª C å¤´æ–‡ä»¶åº“ã€‚
- **ç®€å• API**ï¼š`start()`, `stop()`, `write()`, `dispose()`ã€‚

---

## ğŸ›  ä½¿ç”¨æ–¹æ³•

### 1. å®‰è£…ä¾èµ–
åœ¨ `pubspec.yaml` ä¸­æ·»åŠ  `miniaudio_ffi`:

```yaml
dependencies:
dependencies:
  flutter_miniaudio:
    git: https://github.com/Hibaogame/flutter_miniaudio.git
    # å¦‚æœæ˜¯æœ¬åœ°è·¯å¾„ï¼š
    # path: packages/flutter_miniaudio
```

### 2. åŸºæœ¬æ’­æ”¾
```dart
import 'package:flutter_miniaudio/flutter_miniaudio.dart';
import 'dart:ffi'; // ç”¨äº Pointer æ“ä½œ

// 1. åˆå§‹åŒ–
final player = MiniaudioPlayer(
  sampleRate: 48000, // æ ‡å‡†é‡‡æ ·ç‡
  channels: 2,       // ç«‹ä½“å£°
  bufferFrames: 1024 // ç¡¬ä»¶ç¼“å†²åŒºå¤§å° (è¶Šå°å»¶è¿Ÿè¶Šä½)
);

// 2. å¯åŠ¨è®¾å¤‡
player.start();

// 3. ç”Ÿæˆå¹¶å†™å…¥éŸ³é¢‘ (ä¾‹å¦‚åœ¨å¾ªç¯ä¸­)
// è·å–ä½ çš„éŸ³é¢‘æ•°æ®æŒ‡é’ˆ (Pointer<Int16>)
player.write(audioDataPointer, frameCount);

// 4. æ¸…ç†
player.dispose();
```

### 3. å®ç°éŸ³é¢‘åŒæ­¥ (ä½œä¸ºä¸»æ—¶é’Ÿ)
ä»¥ä¸‹æ˜¯å¦‚ä½•å°†æ¸¸æˆå¾ªç¯é€šè¿‡éŸ³é¢‘è¿›è¡ŒåŒæ­¥ï¼š

```dart
void gameLoop() {
  // 1. è¿è¡Œä¸€å¸§æ¨¡æ‹Ÿå™¨/æ¸¸æˆ
  emulator.runFrame();
  
  // 2. å°†ç”Ÿæˆçš„éŸ³é¢‘æ¨é€åˆ°æ’­æ”¾å™¨
  player.write(emulator.audioPointer, emulator.audioFrames);
  
  // 3. èŠ‚æµé€»è¾‘ (å…³é”®ç‚¹)
  // æ£€æŸ¥ç¼“å†²åŒºç§¯å‹äº†å¤šå°‘éŸ³é¢‘ã€‚
  // å¦‚æœç§¯å‹è¶…è¿‡ 64msï¼Œè¯´æ˜æ¨¡æ‹Ÿå™¨è·‘å¾—æ¯”éŸ³é¢‘ç¡¬ä»¶å¿«ï¼
  while (player.bufferLatency > 0.064) {
    // ç­‰å¾…ä¸€å°ä¼šå„¿ï¼Œè®©éŸ³é¢‘ç¡¬ä»¶æ¶ˆè€—æ‰ä¸€äº›æ•°æ®ã€‚
    // åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½ä¼š sleep 1msã€‚
    sleep(Duration(milliseconds: 1)); 
  }
}
```

---

## ğŸ”§ API å‚è€ƒ

### `MiniaudioPlayer`

| å±æ€§/æ–¹æ³• | æè¿° |
|-----------------|-------------|
| `MiniaudioPlayer(...)` | æ„é€ å‡½æ•°ã€‚`bufferFrames` æ§åˆ¶ç¡¬ä»¶å»¶è¿Ÿã€‚`fifoCapacityFrames` æ§åˆ¶ç¯å½¢ç¼“å†²åŒºå¤§å°ã€‚ |
| `start()` | å¯åŠ¨éŸ³é¢‘è®¾å¤‡ã€‚ |
| `stop()` | æš‚åœéŸ³é¢‘è®¾å¤‡ã€‚ |
| `write(Pointer<Int16>, int)` | å°†åŸå§‹ PCM é‡‡æ ·å†™å…¥ç¯å½¢ç¼“å†²åŒºã€‚è¿”å›å®é™…å†™å…¥çš„å¸§æ•°ã€‚ |
| `writeList(List<int>)` | è¾…åŠ©æ–¹æ³•ï¼Œä» Dart List å†™å…¥ (æ¯” Pointer æ…¢)ã€‚ |
| `volume` | **è®¾ç½®** ä¸»éŸ³é‡ (0.0 åˆ° 1.0). é»˜è®¤ä¸º 1.0ã€‚ |
| `deviceSampleRate` | **è·å–** å®é™…ç¡¬ä»¶é‡‡æ ·ç‡ (å¦‚ 48000)ã€‚ç”¨äºæ£€æµ‹æ˜¯å¦å‘ç”Ÿé‡é‡‡æ ·ã€‚ |
| `deviceChannels` | **è·å–** å®é™…ç¡¬ä»¶å£°é“æ•°ã€‚ |
| `framesConsumed` | è‡ªå¯åŠ¨ä»¥æ¥æ’­æ”¾çš„æ€»å¸§æ•°ã€‚ |
| `fifoAvailable` | å½“å‰å¯ä»¥å†™å…¥å¤šå°‘é‡‡æ ·æ•°æ®ã€‚ |
| `fifoAvailableFrames` | å½“å‰å¯ä»¥å†™å…¥å¤šå°‘å¸§æ•°æ®ã€‚ |
| `bufferLatency` | å½“å‰ç¼“å†²åŒºç§¯å‹çš„æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œç”¨äºåŒæ­¥æ§åˆ¶ã€‚ |
| `dispose()` | åœæ­¢è®¾å¤‡å¹¶é‡Šæ”¾åŸç”Ÿèµ„æºã€‚ |

---

## è¿›é˜¶ç”¨æ³•: éŸ³é¢‘å¼•æ“ (æ¸¸æˆéŸ³æ•ˆ)

å¯¹äºæ¸¸æˆæˆ– UI éŸ³æ•ˆï¼Œä¸€èˆ¬ä½¿ç”¨ `MiniaudioEngine`ã€‚å®ƒæ”¯æŒå¤šè½¨æ··éŸ³ã€æ–‡ä»¶æ’­æ”¾å’Œ 3D ç©ºé—´éŸ³æ•ˆã€‚

```dart
final engine = MiniaudioEngine();
engine.start();

// æ’­æ”¾å³å¿˜çš„ UI éŸ³æ•ˆ
engine.playOneShot("assets/click.wav");

// æ’­æ”¾èƒŒæ™¯éŸ³ä¹ (æ”¯æŒå¾ªç¯å’Œæ§åˆ¶)
final bgm = await engine.loadSound("assets/music.mp3");
bgm.looping = true;
bgm.volume = 0.5;
bgm.play();

// 3D éŸ³æ•ˆç¤ºä¾‹
final sfx = await engine.loadSound("assets/explosion.wav");
sfx.setPosition3D(10, 0, 0); // åœ¨å¬è€…å³ä¾§
sfx.setFadeIn(0, 1.0, 48000); // 1ç§’é’Ÿæ·¡å…¥ (å‡è®¾é‡‡æ ·ç‡48k)
sfx.play();
```

### API å‚è€ƒ - å¼•æ“ (Engine)

#### `MiniaudioEngine`
| API | æè¿° |
| --- | --- |
| `start()` | å¯åŠ¨æ··éŸ³å¼•æ“ã€‚ |
| `stop()` | åœæ­¢å¼•æ“ã€‚ |
| `playOneShot(path)` | æ’­æ”¾ä¸€æ¬¡æ€§éŸ³æ•ˆæ–‡ä»¶ï¼Œè‡ªåŠ¨é‡Šæ”¾ã€‚ |
| `loadSound(path)` | åŠ è½½å£°éŸ³å¯¹è±¡ä»¥è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚ |

#### `MiniaudioSound`
| API | æè¿° |
| --- | --- |
| `play()`, `stop()` | æ§åˆ¶æ’­æ”¾çŠ¶æ€ã€‚ |
| `seekToFrame(int)` | è·³è½¬åˆ°æŒ‡å®š PCM å¸§ä½ç½®ã€‚ |
| `volume`, `pitch`, `pan` | åŸºç¡€å±æ€§æ§åˆ¶ã€‚ |
| `setPosition3D(x,y,z)` | è®¾ç½®å£°æºçš„ 3D ç©ºé—´ä½ç½®ã€‚ |
| `setDirection(x,y,z)` | è®¾ç½®å£°æºçš„æœå‘ã€‚ |
| `setVelocity(x,y,z)` | è®¾ç½®å£°æºé€Ÿåº¦ (ç”¨äºå¤šæ™®å‹’æ•ˆåº”)ã€‚ |
| `setFadeIn(beg,end,len)` | è‡ªåŠ¨éŸ³é‡æ·¡å…¥æ·¡å‡ºã€‚ |
| `dispose()` | **å¿…é¡»è°ƒç”¨** ä»¥é‡Šæ”¾åŸç”Ÿå†…å­˜ã€‚ |

#### `MiniaudioContext`
| API | æè¿° |
| --- | --- |
| `getPlaybackDevices()` | è·å–å¯ç”¨è¾“å‡ºè®¾å¤‡åˆ—è¡¨ (åŒ…å«åç§°å’Œ ID)ã€‚ |
| `getCaptureDevices()` | è·å–å¯ç”¨è¾“å…¥è®¾å¤‡åˆ—è¡¨ã€‚ |

---

## ç‰¹æ•ˆä¸èŠ‚ç‚¹å›¾ (Effects & Node Graph)

Miniaudio æ”¯æŒå¼ºå¤§çš„èŠ‚ç‚¹å›¾ç³»ç»Ÿã€‚æ‚¨å¯ä»¥ä¸²è” EQã€é«˜é€šæ»¤æ³¢å™¨å’Œåˆ†é¢‘å™¨ç­‰ç‰¹æ•ˆã€‚

### åŸºç¡€è¿çº¿ (Wiring)
é»˜è®¤æƒ…å†µä¸‹ï¼Œå£°éŸ³ç›´æ¥è¿æ¥åˆ°å¼•æ“çš„ç»ˆç‚¹ï¼ˆæ‰¬å£°å™¨ï¼‰ã€‚æ‚¨å¯ä»¥å°†å…¶æ–­å¼€å¹¶é‡æ–°è¿æ¥åˆ°ç‰¹æ•ˆèŠ‚ç‚¹ã€‚

```dart
// 1. åˆ›å»ºèŠ‚ç‚¹ (ä¾‹å¦‚ Peaking EQ)
final eq = engine.createPeakingEq();
eq.setParams(gainDB: 10, q: 1.0, frequency: 1000);

// 2. å°† EQ è¿æ¥åˆ°æ‰¬å£°å™¨ (Master)
eq.connectTo(engine.master);

// 3. åŠ è½½å£°éŸ³ (é»˜è®¤è‡ªåŠ¨è¿æ¥åˆ° Master)
final sound = await engine.loadSound("music.mp3");

// 4. é‡æ–°è·¯ç”±: Sound -> EQ -> Master
sound.detach(); 
sound.connectTo(eq);

sound.play();
```

### æ”¯æŒçš„èŠ‚ç‚¹
*   `PeakingEqNode`: å‚é‡å‡è¡¡å™¨ã€‚
*   `LowShelfNode`: ä½é¢‘æ¶å¼æ»¤æ³¢å™¨ã€‚
*   `HighShelfNode`: é«˜é¢‘æ¶å¼æ»¤æ³¢å™¨ã€‚
*   `LowPassFilterNode` (`LPF`): ä½é€šæ»¤æ³¢å™¨ (å‰Šå‡é«˜é¢‘)ã€‚
*   `HighPassFilterNode` (`HPF`): é«˜é€šæ»¤æ³¢å™¨ (å‰Šå‡ä½é¢‘)ã€‚
*   `DelayNode`: å»¶è¿Ÿ/å›å£°èŠ‚ç‚¹ã€‚
*   `ReverbNode`: æ··å“èŠ‚ç‚¹ã€‚
*   `SplitterNode`: ä¿¡å·åˆ†ç¦»å™¨ (é€šè¿‡ `connectTo(..., inputBusIndex)` è¿æ¥åˆ°ä¸åŒè¾“å…¥)ã€‚

---

## ğŸ“ è®¸å¯è¯

MIT License. è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚
åŸºäº David Reid çš„ [miniaudio](https://github.com/mackron/miniaudio) å¼€å‘ã€‚
